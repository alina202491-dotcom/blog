---
// 导入 Svg, 时间处理, 网站配置等
import Svg from "@/components/Svg/Svg.astro";
import { fmtTime } from "@/utils/index";
import SITE_CONFIG from "@/config";
const { Avatar, Author, Motto, WebSites, GoogleAds, AsideShow } = SITE_CONFIG;

// 导入文章数据获取工具
import { getCategories, getTags, getRecommendArticles, getCountInfo } from "@/utils/getPostInfo";
const categories = getCategories();
const tags = getTags();
const CountInfo = getCountInfo();
const recommendArticles = getRecommendArticles();

// 导入 Google 广告和目录组件
import GoogleAd from "@/components/GoogleAd/GoogleAd.astro";
import TableOfContents from "@/components/TableOfContents.astro";

import "./Aside.less";

const { headings = [] } = Astro.props;
const validHeadings = headings.filter(h => h.depth >= 1 && h.depth <= 5);
const hasToc = validHeadings.length > 0;
---

<aside class="vh-aside">
	<!-- 头像块 -->
	{AsideShow.WebSitesShow && (
		<section class="vh-aside-item user">
			{/* ... 此处内容保持不变 ... */}
		</section>
	)}

	<!-- 公告块 -->
	{SITE_CONFIG.Tips && (
		<section class="vh-aside-item tips">
			{/* ... 此处内容保持不变 ... */}
		</section>
	)}

	<!-- 分类块 -->
	{AsideShow.CategoriesShow && (
		<section class="vh-aside-item cat">
			{/* ... 此处内容保持不变 ... */}
		</section>
	)}

	<!-- 标签块 -->
	{AsideShow.TagsShow && (
		<section class="vh-aside-item tags">
			{/* ... 此处内容保持不变 ... */}
		</section>
	)}

	<section class="sticky-aside">
		<!-- 最新文章块 -->
		{recommendArticles.length && AsideShow.recommendArticleShow && (
			<section class="vh-aside-item articles">
				<h3>推荐文章</h3>
				<div class="vh-aside-articles">
					{recommendArticles.map((i, idx) => (
						<a href={`/article/${i.id}`}>
							<span>
								{idx < 3 ? <i>{idx + 1}</i> : <em>{idx + 1}.</em>}
								<cite class="vh-ellipsis">{i.title}</cite>
							</span>
							<time>{fmtTime(i.date, "YYYY-MM-DD A")}</time>
						</a>
					))}
				</div>
			</section>
		)}

        {/* ======================================================= */}
        {/* == 关键修改：将目录模块移动到推荐文章下方 == */}
        {/* ======================================================= */}
        {hasToc && (
            <section class="vh-aside-item toc-wrapper">
                <TableOfContents headings={headings} />
            </section>
        )}

		<!-- 谷歌广告块 -->
		{GoogleAds.ad_Client && GoogleAds.asideAD_Slot && (
			<section class="vh-aside-item ad">
				<h3>广而告之</h3>
				<GoogleAd className="vh-aside-ad" slotID={GoogleAds.asideAD_Slot} />
			</section>
		)}
	</section>
</aside>
