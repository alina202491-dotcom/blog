---
// 导入 Svg, 时间处理, 网站配置等
import Svg from "@/components/Svg/Svg.astro";
import { fmtTime } from "@/utils/index";
import SITE_CONFIG from "@/config";
const { Avatar, Author, Motto, WebSites, GoogleAds, AsideShow } = SITE_CONFIG;

// 导入文章数据获取工具
import { getCategories, getTags, getRecommendArticles, getCountInfo } from "@/utils/getPostInfo";
const categories = getCategories();
const tags = getTags();
const CountInfo = getCountInfo();
const recommendArticles = getRecommendArticles();

// 导入 Google 广告和目录组件
import GoogleAd from "@/components/GoogleAd/GoogleAd.astro";
import TableOfContents from "@/components/TableOfContents.astro"; // 关键：导入目录组件

// 侧边栏样式
import "./Aside.less";

// =======================================================
// == 关键修改：接收并处理 headings 数据 ==
// =======================================================
const { headings = [] } = Astro.props;
// 检查是否存在有效的、可供显示的标题 (H2/H3)
const validHeadings = headings.filter(h => h.depth > 1 && h.depth <= 3);
const hasToc = validHeadings.length > 0;
---

<aside class="vh-aside">
	<!-- 头像块 -->
	{AsideShow.WebSitesShow && (
		<section class="vh-aside-item user">
			{/* ... 此处内容保持不变 ... */}
			<img class="vh-aside-avatar" src="/assets/images/lazy-loading.webp" data-vh-lz-src={Avatar} alt={Author} />
			<span class="vh-aside-auther">{Author}</span>
			<p class="vh-aside-motto">{Motto}</p>
			<section class="vh-aside-links">
				{WebSites.map(item => (
					<a class="vh-aside-links-item" href={item.link} title={item.text} target="_blank" rel="noopener nofollow">
						<Svg src={item.icon} />
					</a>
				))}
			</section>
			<section class="vh-aside-info">
				<div class="art-item count"><span>{CountInfo.ArticleCount}</span><p>文章数</p></div>
				<div class="cat-item count"><span>{CountInfo.CategoryCount}</span><p>分类数</p></div>
				<div class="tag-item count"><span>{CountInfo.TagCount}</span><p>标签数</p></div>
			</section>
			<canvas class="vh-aside-canvas" width="888" height="1888" />
		</section>
	)}

	<!-- 公告块 -->
	{SITE_CONFIG.Tips && (
		<section class="vh-aside-item tips">
			<span><svg>...</svg>公告</span>
			<div class="tips-content"><Fragment set:html={SITE_CONFIG.Tips} /></div>
		</section>
	)}

	{/* ======================================================= */}
	{/* == 关键新增：在公告下方，有条件地渲染目录模块 == */}
	{/* ======================================================= */}
	{hasToc && (
		<section class="vh-aside-item toc-wrapper">
			<TableOfContents headings={headings} />
		</section>
	)}

	<!-- 分类块 -->
	{AsideShow.CategoriesShow && (
		<section class="vh-aside-item cat">
			{/* ... 此处内容保持不变 ... */}
		</section>
	)}

	<!-- 标签块 -->
	{AsideShow.TagsShow && (
		<section class="vh-aside-item tags">
			{/* ... 此处内容保持不变 ... */}
		</section>
	)}

	<section class="sticky-aside">
		{/* ... 此处内容保持不变 ... */}
	</section>
</aside>
