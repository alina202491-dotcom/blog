---
// src/components/widget/VisitorCard.astro
---
<div id="visitor-info-card" class="w-full bg-white rounded-2xl shadow-lg p-6 transition-all duration-500 mb-4">
    <div class="flex items-center border-b border-gray-200 pb-4 mb-4">
        <i class="fas fa-user-secret text-xl text-blue-500"></i>
        <h2 class="text-lg font-bold text-gray-800 ml-3">访客信息</h2>
    </div>
    <div class="space-y-4 text-sm">
        <div class="flex items-center"><i class="fas fa-network-wired w-5 text-center text-gray-400"></i><span class="text-gray-600 font-semibold ml-3 mr-2">IP 地址:</span><span id="ip-address" class="text-gray-800 font-mono"><div class="loading-placeholder"></div></span></div>
        <div class="flex items-center"><i class="fas fa-map-marker-alt w-5 text-center text-gray-400"></i><span class="text-gray-600 font-semibold ml-3 mr-2">地理位置:</span><span id="location" class="text-gray-800"><div class="loading-placeholder"></div></span></div>
        <div class="flex items-center"><i class="fas fa-road w-5 text-center text-gray-400"></i><span id="distance-label" class="text-gray-600 font-semibold ml-3 mr-2">与北京距离:</span><span id="distance" class="text-gray-800"><div class="loading-placeholder"></div></span></div>
        <div class="flex items-center"><i class="fas fa-wifi w-5 text-center text-gray-400"></i><span class="text-gray-600 font-semibold ml-3 mr-2">运 营 商:</span><span id="isp" class="text-gray-800"><div class="loading-placeholder"></div></span></div>
        <div class="flex items-center"><i class="fas fa-laptop-code w-5 text-center text-gray-400"></i><span class="text-gray-600 font-semibold ml-3 mr-2">操作系统:</span><span id="os" class="text-gray-800"><div class="loading-placeholder"></div></span></div>
        <div class="flex items-center"><i class="fab fa-chrome w-5 text-center text-gray-400"></i><span class="text-gray-600 font-semibold ml-3 mr-2">浏 览 器:</span><span id="browser" class="text-gray-800"><div class="loading-placeholder"></div></span></div>
    </div>
    <div class="border-t border-gray-200 pt-3 mt-5 text-xs text-gray-400 text-center">由 Astro 提供支持</div>
</div>

<style>
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
    .loading-placeholder { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; background-color: #e5e7eb; border-radius: 0.25rem; height: 1.25rem; width: 75%; }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const ipAddressEl = document.getElementById('ip-address');
        const locationEl = document.getElementById('location');
        const ispEl = document.getElementById('isp');
        const osEl = document.getElementById('os');
        const browserEl = document.getElementById('browser');
        const distanceLabelEl = document.getElementById('distance-label');
        const distanceEl = document.getElementById('distance');

        // 关键点：请求项目内部的 API 路由
        const apiUrl = '/api/visitor'; 

        async function fetchVisitorInfo() {
            try {
                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error(`网络响应错误: ${response.status}`);
                const data = await response.json();
                if (data && data.ip) {
                    ipAddressEl.textContent = data.ip || '未知';
                    locationEl.textContent = data.address || '未知';
                    ispEl.textContent = data.isp || '未知';
                    osEl.textContent = data.os || '未知';
                    browserEl.textContent = data.browser || '未知';
                    distanceEl.textContent = data.distance || '未知';
                    distanceLabelEl.textContent = `与${data.targetLocationName}距离:`;
                } else { throw new Error('API 返回的数据格式不正确'); }
            } catch (error) {
                console.error('获取访客信息失败:', error);
                const errorMessage = '信息加载失败';
                ipAddressEl.textContent = errorMessage;
                locationEl.textContent = errorMessage;
                ispEl.textContent = errorMessage;
                osEl.textContent = errorMessage;
                browserEl.textContent = errorMessage;
                distanceEl.textContent = errorMessage;
            }
        }
        fetchVisitorInfo();
    });
</script>
