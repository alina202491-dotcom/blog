---
// src/components/MusicPlayer.astro
// 【更新】
// 使用你提供的最新 API 动态加载网易云热歌榜。
// 这是目前最先进的方案。
---

<!-- 1. 引入 APlayer 的 CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css">

<!-- 2. APlayer 播放器的挂载点 -->
<div id="aplayer"></div>

<!-- 3. 引入 APlayer 的 JS -->
<script is:inline src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script>

<!-- 4. 初始化 APlayer 的脚本 -->
<script is:inline>
  document.addEventListener('DOMContentLoaded', function () {
    // 你提供的 API 地址
    const apiUrl = 'https://node.api.xfabe.com/api/wangyi/musicChart?list=%E7%83%AD%E6%AD%8C%E6%A6%9C';

    // 使用 fetch 调用 API
    fetch(apiUrl)
      .then(response => {
        if (!response.ok) {
          throw new Error('网络响应错误');
        }
        return response.json();
      })
      .then(result => {
        // 检查 API 返回的数据是否有效
        if (!result || result.code !== 200 || !result.data || result.data.length === 0) {
          console.error('API 未返回有效的歌曲数据。');
          return;
        }

        // 将 API 返回的数据格式化为 APlayer 需要的格式
        const audioList = result.data.map(song => {
          // 确保 musicUrl 存在，防止出错
          if (!song.musicUrl) {
            return null;
          }
          return {
            name: song.name,
            artist: song.artists.map(a => a.name).join(' / '),
            url: song.musicUrl,
            cover: song.cover,
          };
        }).filter(Boolean); // 过滤掉 musicUrl 为空的歌曲

        if (audioList.length === 0) {
          console.error('处理后的歌曲列表为空。');
          return;
        }

        // 初始化 APlayer
        new APlayer({
          container: document.getElementById('aplayer'),
          fixed: true,
          mini: true,
          theme: '#2980b9',
          audio: audioList
        });
      })
      .catch(error => {
        console.error('获取或处理音乐数据时出错:', error);
      });
  });
</script>

<style is:global>
  .aplayer.aplayer-fixed {
    position: fixed !important;
    left: 15px !important;
    bottom: 15px !important;
    z-index: 2147483647 !important;
  }
</style>
