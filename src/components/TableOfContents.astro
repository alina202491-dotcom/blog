---
// src/components/TableOfContents.astro
const { headings } = Astro.props;

// 关键修改 1: 扩展过滤器以包含 h1 到 h5
const filteredHeadings = headings.filter(h => h.depth >= 1 && h.depth <= 5);

// --- 扩展的编号逻辑 ---
let counters = [0, 0, 0, 0, 0]; // 为 h1-h5 分别设置计数器
const numberedHeadings = filteredHeadings.map(heading => {
    const depthIndex = heading.depth - 1;
    counters[depthIndex]++; // 对应层级的计数器加 1

    // 重置所有更深层级的计数器
    for (let i = depthIndex + 1; i < counters.length; i++) {
        counters[i] = 0;
    }

    // 只为 h1, h2, h3 生成编号
    let number = '';
    if (heading.depth === 1) {
        number = `${counters[0]}.`;
    } else if (heading.depth === 2) {
        number = `${counters[0]}.${counters[1]}`;
    } else if (heading.depth === 3) {
        number = `${counters[0]}.${counters[1]}.${counters[2]}`;
    }

    return { ...heading, number };
});

import "./TableOfContents.less";
---

{numberedHeadings.length > 0 && (
    <div class="toc-container">
        <h3 class="toc-title">本页目录</h3>
        <ul class="toc-list">
            {numberedHeadings.map(heading => (
                <li class={`toc-item depth-${heading.depth}`}>
                    <a href={`#${heading.slug}`}>
                        {heading.number && <span class="toc-number">{heading.number}</span>}
                        <span class="toc-text">{heading.text}</span>
                    </a>
                </li>
            ))}
        </ul>
    </div>
)}

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const tocLinks = document.querySelectorAll('.toc-list a');
        if (tocLinks.length === 0) return;

        const observer = new IntersectionObserver(entries => {
            entries.forEach(entry => {
                const id = entry.target.getAttribute('id');
                const tocLink = document.querySelector(`.toc-list a[href="#${id}"]`);
                
                if (tocLink) {
                    if (entry.isIntersecting) {
                        document.querySelectorAll('.toc-list a').forEach(link => link.classList.remove('active'));
                        tocLink.classList.add('active');
                    }
                }
            });
        }, { rootMargin: '0% 0% -80% 0%', threshold: 1.0 });

        // 关键修改 2: 监听所有 h1 到 h5 标题
        document.querySelectorAll('article h1[id], article h2[id], article h3[id], article h4[id], article h5[id]').forEach(heading => {
            observer.observe(heading);
        });
    });
</script>
